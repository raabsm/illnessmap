<!DOCTYPE html>
<html>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<!--    <script src = "https://code.jquery.com/jquery-1.10.2.js"></script>-->
    <script src = "https://code.jquery.com/ui/1.10.4/jquery-ui.js"></script>
    <script src = "https://d3js.org/d3.v4.js"></script>

     <link href = "https://code.jquery.com/ui/1.10.4/themes/ui-lightness/jquery-ui.css"
              rel = "stylesheet">
    <link href="https://use.fontawesome.com/releases/v5.13.0/css/all.css" rel="stylesheet">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
<!--     <link rel="stylesheet" type="text/css" href="/static/rating.css">-->

    <link rel="stylesheet" type="text/css" href="/css/styles.css">
  </head>
   <div id="data-box" class="nicebox">
       <div class="table-row">
          <label id="mouseover-type" class="data-label" for="mouseover-name"></label>
          <span id="mouseover-name" class="data-value"></span>
       </div>
       <div class="table-row">
          <label class="data-label" for="sick_score">Sick Score:</label>
          <span id=sick_score class="data-value"></span>
       </div>
    </div>

    <div id=slider-box class="text-box">

            <div class="slider-title">Sick Review Slider</div>

            <div id="sick-slider-text" class="rest-info"></div>
            <div id = "sick-review-slider"></div>


            <div class="slider-title">Date Slider</div>
            <form id="select-form" style = "display: inline; float: right; margin-top: 4px">
              <select id="date-select" class="form-control form-control-sm" style="height: 20px;">
                  <option selected="selected" value = "custom">Custom</option>
                  <option value = "week">Last Week</option>
                  <option value = "month">Last Month</option>
                  <option value = "6month">Last 6 Months</option>
                  <option value = "year">Last Year</option>
              </select>
            </form>
            <div id="date-slider-text" class="rest-info"></div>
            <div id = "date-slider"></div>


           <div class="slider-title">Restaurant Threshold Slider</div>
            <div id="rest-slider-text" class="rest-info"></div>
            <div id = "sick-rest-slider"></div>

            <div id="radio-buttons" class="btn-group btn-group-sm btn-group-toggle" data-toggle="buttons" style="margin-top:5px">
                <label class="btn btn-secondary">
                    <input type="radio" name="classification" value="reg_total_score" autocomplete="off">LR
                </label>
                 <label class="btn btn-secondary">
                    <input type="radio" name="classification" value="hsan_total_score" autocomplete="off">HSAN
                 </label>
                 <label class="btn btn-secondary active">
                    <input type="radio" name="classification" value="union" autocomplete="off" checked>Union
                 </label>
            </div>
          <div style="margin-top:5px"><button class="btn btn-primary btn-sm" onclick="scaleUp()">Scale Up</button></div>
<!--        <button class="btn btn-primary btn-sm" onclick="deselectMarker()">Deselect</button>-->
        <div><button class="btn btn-success btn-sm" onclick="changeMap()" style="float:right;">Submit</button></div>

	</div>

   <div id="rest-info-box" class="text-box">
       <button type="button" class="close" aria-label="Close" onclick="deselectMarker()">
           <span aria-hidden="true">&times;</span>
       </button>

       <a href="#" target = "_blank" id="rest-title"></a>
       <div class="rest-info">
           <div class="rest-info-title"><img id="rest-rating"><span id="total-reviews" class="rest-info-span"></span></div>
       </div>
       <p></p>
       <div class="rest-info">
           <i class="fas fa-map-marker-alt"></i>
           <span id="address" class="rest-info-span"></span>
       </div>
       <div class="rest-info">
           <i class="fas fa-phone"></i>
           <span id="phone-number" class="rest-info-span"></span>
       </div>
        <div class="rest-info">
           <i class="fas fa-globe-americas"></i>
           <span class="rest-info-span"><a href="#" target = "_blank" id="rest-website"></a></span>
       </div>
        <div class="rest-info">
           <i class="fas fa-chart-line"></i>
           <span id="sick-score" class="rest-info-span"></span>
       </div>
       <p></p>
       <div class="rest-info" style="width: 25%;">
         <form style = "margin-top: 4px;">
              <select id="sort-by-select" class="form-control form-control-sm">
                  <option selected="selected" value = "date">Sort By <b>Date</b></option>
                  <option value = "hsan">Sort By <b>HSAN</b></option>
                  <option value = "lr">Sort By <b>LR</b></option>
              </select>
         </form>
       </div>
       <div id="reviews">
       </div>
       <button class="btn btn-primary btn-sm"  onclick="openBusinessWindow()" style="float:right; margin-top:8px;">More Info</button>
   </div>

  <div id="histogram"></div>

    <div id="map"></div>
    <script>
      var map;
      var sickMin = Number.MAX_VALUE, sickMax = -Number.MAX_VALUE;
      var sickReviewBottomThreshold = 0.5;
      var sickReviewTopThreshold = 1.0;
      var sickRestaurantThreshold = 5;
      var scalingFactor = 3;
      var selectedMarker = null;
      var xhr = null;
      var classification = 'union';
      var allReviewsForSelectedMarker = null;

      var zipFeature = {'feature': null, 'over': false};
      var markers = [];

      var startTime = (new Date(2019, 1, 1)).getTime();
      var endTime = (new Date()).getTime();

      var margin = {top: 10, right: 30, bottom: 30, left: 40},
                    width = 450 - margin.left - margin.right,
                    height = 100 - margin.top - margin.bottom;

        // append the svg object to the body of the page
      var svg = d3.select("#histogram")
          .append("svg")
          .attr("width", width + margin.left + margin.right)
          .attr("height", height + margin.top + margin.bottom)
          .append("g")
          .attr("transform",
              "translate(" + margin.left + "," + margin.top + ")");
      var reviewsForHist = [];
      var y = d3.scaleLinear().range([height, 0]);
      var yAxis = svg.append("g");

      var x = d3.scaleTime().domain([new Date(startTime), new Date(endTime)]).range([0, width]);
      var xAxis = svg.append("g").attr("transform", "translate(0," + height + ")");

      var starRatings = {
          0.0: '0.png',
          0.5: '0.png',
          1.0: '1.png',
          1.5: '1_half.png',
          2.0: '2.png',
          2.5: '2_half.png',
          3.0: '3.png',
          3.5: '3_half.png',
          4.0: '4.png',
          4.5: '4_half.png',
          5.0: '5.png'
      };

      function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
          zoom: 11,
          center: new google.maps.LatLng(40.75,-74.00),
            styles: [
              {
                "elementType": "labels",
                "stylers": [
                  {
                    "visibility": "off"
                  }
                ]
              },
              {
                "featureType": "administrative",
                "elementType": "geometry",
                "stylers": [
                  {
                    "visibility": "off"
                  }
                ]
              },
              {
                "featureType": "administrative.land_parcel",
                "stylers": [
                  {
                    "visibility": "off"
                  }
                ]
              },
              {
                "featureType": "administrative.neighborhood",
                "stylers": [
                  {
                    "visibility": "off"
                  }
                ]
              },
              {
                "featureType": "poi",
                "stylers": [
                  {
                    "visibility": "off"
                  }
                ]
              },
              {
                "featureType": "road",
                "elementType": "labels.icon",
                "stylers": [
                  {
                    "visibility": "off"
                  }
                ]
              },
              {
                "featureType": "transit",
                "stylers": [
                  {
                    "visibility": "off"
                  }
                ]
              }
            ]
//            styles: [
//   {
//     "featureType": "administrative.land_parcel",
//     "stylers": [
//       {
//         "visibility": "off"
//       }
//     ]
//   },
//   {
//     "featureType": "administrative.neighborhood",
//     "stylers": [
//       {
//         "visibility": "off"
//       }
//     ]
//   },
//   {
//     "featureType": "poi",
//     "elementType": "labels.text",
//     "stylers": [
//       {
//         "visibility": "off"
//       }
//     ]
//   },
//   {
//     "featureType": "poi.business",
//     "stylers": [
//       {
//         "visibility": "off"
//       }
//     ]
//   },
//   {
//     "featureType": "road",
//     "elementType": "labels",
//     "stylers": [
//       {
//         "visibility": "off"
//       }
//     ]
//   },
//   {
//     "featureType": "road",
//     "elementType": "labels.icon",
//     "stylers": [
//       {
//         "visibility": "off"
//       }
//     ]
//   },
//   {
//     "featureType": "transit",
//     "stylers": [
//       {
//         "visibility": "off"
//       }
//     ]
//   },
//   {
//     "featureType": "water",
//     "elementType": "labels.text",
//     "stylers": [
//       {
//         "visibility": "off"
//       }
//     ]
//   }
// ]
        });
        loadGeoJson();
        // google.maps.event.addDomListener(document.getElementById('map'), 'dblclick', function() {
        //     document.getElementById('rest-info-box').style.display = 'none';
        //     if(selectedMarker != null){
        //         makeNeutralIcon(selectedMarker, 5);
        //         selectedMarker = null;
        //     }
        // });

        map.data.setStyle(styleFeature);
        map.data.addListener('mouseover', mouseInToRegion);
        map.data.addListener('mouseout', mouseOutOfRegion);

    }

    function deselectMarker(){
          document.getElementById('rest-info-box').style.display = 'none';
            if(selectedMarker != null){
                makeNeutralIcon(selectedMarker);
                selectedMarker = null;
            }
    }

    function openBusinessWindow(){
        let params = {
            business_id: selectedMarker.rest_info.id,
            start_time: startTime,
            end_time: endTime,
            review_bottom_threshold: sickReviewBottomThreshold,
            review_top_threshold: sickReviewTopThreshold
        };
        OpenWindowWithPost("/restaurant_info", params);
    }

    function OpenWindowWithPost(url, params)
   {
            var form = document.createElement("form");
            form.setAttribute("method", "post");
            form.setAttribute("action", url);
            form.setAttribute("target", '_blank');

            for (var i in params) {
                if (params.hasOwnProperty(i)) {
                    var input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = i;
                    input.value = params[i];
                    form.appendChild(input);
                    console.log(input)
                }
            }

            document.body.appendChild(form);
            form.submit();
            document.body.removeChild(form);
    }

    function changeMap(){
          reviewsForHist = [];
        classification = document.querySelector('input[name="classification"]:checked').value;
        if(xhr)
            xhr.abort();

        console.log(getFormattedDate(new Date(startTime)), getFormattedDate(new Date(endTime)), classification);
        for(var i = 0; i<markers.length; i++){
            if(markers[i] !== selectedMarker)
                markers[i].setMap(null);
        }
        markers = [];
        if(selectedMarker != null){
            markers.push(selectedMarker);
        }
        loadRestaurants();
    }

    $(function (){
        $("#sick-review-slider").slider({
            range: true,
            min: 0.1,
            max: 1.0,
            step: 0.1,
            values: [sickReviewBottomThreshold, sickReviewTopThreshold],
            slide: function(event, ui){
                 $("#sick-slider-text").text( ui.values[0] + " - " + ui.values[1]);
            },
            stop: function(event, ui){
                sickReviewBottomThreshold = ui.values[0];
                sickReviewTopThreshold = ui.values[1];
            }
		})

        let sliderStartTime = new Date(2019, 1, 1).getTime();

        $("#date-slider").slider({
            range: true,
            min: sliderStartTime / 1000,
            max: endTime / 1000,
            step: 604800,
            values: [startTime / 1000, endTime / 1000],
            slide: function( event, ui ) {
                 $( "#date-slider-text" ).text( getFormattedDate(new Date(ui.values[ 0 ] *1000)) + " - " + getFormattedDate(new Date(ui.values[ 1 ] *1000)));
             },
            change: function(event, ui){
                $( "#date-slider-text" ).text( getFormattedDate(new Date(ui.values[0] *1000)) + " - " + getFormattedDate(new Date(ui.values[1] *1000)));
                startTime = ui.values[0] * 1000;
                endTime = ui.values[1] * 1000;
            }
		})

         $("#sick-rest-slider").slider({
            min: 1,
            max: 10,
            step: 1,
            value: sickRestaurantThreshold,
            slide: function( event, ui ) {
                 $( "#rest-slider-text" ).text(ui.value);
             },
            stop: function(event, ui){
                sickRestaurantThreshold = ui.value;
            }
		})

        $("#sick-slider-text").text(sickReviewBottomThreshold + " - " + sickReviewTopThreshold);
        $("#date-slider-text").text(getFormattedDate(new Date(startTime)) + " - " + getFormattedDate(new Date(endTime)));
        $("#rest-slider-text").text(sickRestaurantThreshold);

        $("#date-select").on("change", function() {
            var today = new Date();
            let option = this.value;
            var date = new Date();
            $("#date-slider").slider("disable");
            if (option == 'week'){
                date.setDate(today.getDate() - 7);
            }
            else if(option == 'month'){
                date.setMonth(today.getMonth() - 1);
            }
            else if(option == '6month'){
                date.setMonth(today.getMonth() - 6);
            }
            else if(option == 'year'){
                date.setFullYear(today.getFullYear() - 1);
            }
            else{
                $("#date-slider").slider("enable");
                date = new Date(startTime);
            }
            $("#date-slider").slider("values", [date.getTime()/1000, today.getTime()/1000]);
        })

        $("#sort-by-select").on("change", function() {
            let option = this.value;

            if(option == 'date'){
                displaySickReviews(selectedMarker.reviews, compareDates, 'reviews');
            }
            else if(option == 'hsan'){
                displaySickReviews(selectedMarker.reviews, compareHSANScores, 'reviews');
            }
            else{
                displaySickReviews(selectedMarker.reviews, compareLRScores, 'reviews');
            }
        })
    })

      function getFormattedDate(date) {
          var year = date.getFullYear();

          var month = (1 + date.getMonth()).toString();
          month = month.length > 1 ? month : '0' + month;

          var day = date.getDate().toString();
          day = day.length > 1 ? day : '0' + day;

          return month + '/' + day + '/' + year;
      }

    function loadRestaurants(){
        xhr = $.getJSON("/static/2019_sick_reviews.json", function(zip_codes){
            sickMin = Number.MAX_VALUE;
            sickMax = -Number.MAX_VALUE;

            for(var zip in zip_codes){
                let reviewDatesPerZip = [];
                businesses = zip_codes[zip];
                var zip_sick_count = 0;
                businesses.forEach(function (business){
                   let latlng = new google.maps.LatLng(business['lat-long'][0],
                           business['lat-long'][1]);

                   let reviews = [];

                   let aboveThreshold = 0;
                   for(var i = 0; i<business['reviews'].length; i++) {
                       let reviewScore = 0;
                       if(classification == 'union'){
                           reviewScore = Math.max(business['reviews'][i]['reg_total_score'], business['reviews'][i]['hsan_total_score']);
                       }
                       else{
                           reviewScore = business['reviews'][i][classification];
                       }
                       var reviewTime = Date.parse(business['reviews'][i]['date_created']);

                       if (reviewScore < sickReviewBottomThreshold ||
                           reviewScore > sickReviewTopThreshold ||
                           reviewTime < startTime ||
                           reviewTime > endTime) {

                           continue;
                       } else {
                           reviews.push(business['reviews'][i]);
                           reviewsForHist.push(new Date(reviewTime));
                           reviewDatesPerZip.push(new Date(reviewTime));
                           aboveThreshold += 1;
                       }
                   }
                   zip_sick_count += aboveThreshold;

                   if(selectedMarker != null && selectedMarker.rest_info.id == business['business_id']){
                       console.log("ran if statement on", selectedMarker.rest_info.name);
                       selectedMarker.normal_icon.scale = aboveThreshold/scalingFactor;
                       selectedMarker.reviews = reviews;
                       selectedMarker.rest_info.total_review_count = business['review_count'];
                       selectedMarker.rest_info.rating = business['rating'];
                       selectedMarker.sick_score = aboveThreshold;
                       updateClickBox(selectedMarker, compareDates);
                       return;
                   }

                   if(aboveThreshold < sickRestaurantThreshold){
                     return;
                   }

                   var regular_icon = {
                           path: google.maps.SymbolPath.CIRCLE,
                           scale: aboveThreshold/scalingFactor,
                           fillColor: 'blue',
                           fillOpacity: 0.3,
                           strokeWeight: 1,
                           strokeColor:'grey'
                       };

                   var marker = new google.maps.Marker({
                       map: map,
                       normal_icon: regular_icon,
                       icon: regular_icon,
                       position: latlng,
                       sick_score: aboveThreshold,
                       reviews: reviews,
                       rest_info:{
                           name: business['name'],
                           id: business['business_id'],
                           address: business['address'],
                           total_review_count: business['review_count'],
                           url: business['url'],
                           business_url: business['business_url'],
                           rating: business['rating'],
                           phone: business['phone']
                       },
                       zIndex: 999
                   })

                   google.maps.event.addListener(marker, 'mouseover', function() {
                        updateMouseoverBox('Restaurant Name:', this.rest_info.name, this.sick_score);

                        var icon = this.icon;
                        icon.scale = this.normal_icon.scale + 3;
                        this.setIcon(icon);
                    });

                    google.maps.event.addListener(marker, 'click', function() {
                        updateClickBox(this);
                        if(selectedMarker != null){
                            makeNeutralIcon(selectedMarker);
                        }
                        selectedMarker = this;
                        this.setIcon('https://www.google.com/mapfiles/marker_green.png');
                    });

                   google.maps.event.addListener(marker, 'mouseout', function() {
                       if(zipFeature['over']){
                           var feature = zipFeature['feature'];
                           var sickScoreString = feature.getProperty('sick_score');
                           updateMouseoverBox('Zip Code:', feature.getProperty('postalcode'), sickScoreString);
                       }

                       if(selectedMarker!== this){
                           makeNeutralIcon(this);
                       }
                   });  
                   markers.push(marker);
                })

                if(zip_sick_count > sickMax){
                    sickMax = zip_sick_count;
                }
                if(zip_sick_count < sickMin){
                    sickMin = zip_sick_count;
                }
                var feature = map.data.getFeatureById(zip);
                if(feature === undefined){
                   // console.log("undefined");
                }
                else{
                    feature.setProperty('sick_score', zip_sick_count);
                    feature.setProperty('review_dates', reviewDatesPerZip);
                }
            }
            xhr = null;
            changeHistogram(reviewsForHist);
    	}).fail(function (jqxhr, status, error) {
                console.log('error', status, error) }
            );
	}

	function makeNeutralIcon(marker){
        marker.setIcon(marker.normal_icon);
    }
    function loadGeoJson() {
        map.data.loadGeoJson('/static/nyc_zip_code.geojson', {idPropertyName :'postalcode'});
        google.maps.event.addListenerOnce(map.data, 'addfeature', function() {
    //        loadSickData();
            loadRestaurants();
        });
    }

    function scaleUp(){
          for(var i =0; i < markers.length; i++){
              var icon = markers[i].normal_icon;
              icon.scale += 2;
              markers[i].normal_icon = icon;
              if(markers[i] !== selectedMarker)
                  markers[i].setIcon(icon);
          }
    }

    function updateClickBox(marker){
          var restInfo = marker.rest_info;
          var sickScore = marker.sick_score;
          var box = document.getElementById('rest-info-box');
          box.style.display = 'block';
          document.getElementById('rest-title').href = restInfo.url;
          document.getElementById('rest-title').textContent = restInfo.name;
          document.getElementById('address').textContent = restInfo.address;
          document.getElementById('rest-rating').src = '/images/yelp-ratings-large/' + getImgFromRating(restInfo.rating);
          document.getElementById('total-reviews').textContent = restInfo.total_review_count + ' Reviews';
          document.getElementById('rest-website').href = restInfo.business_url;
          document.getElementById('rest-website').textContent = restInfo.business_url;
          document.getElementById('sick-score').textContent = sickScore + ' Sick Reviews (within slider bounds)';
          document.getElementById('phone-number').textContent = formatPhoneNumber(restInfo.phone);

          displaySickReviews(marker.reviews, compareDates, 'reviews');
    }

    function formatPhoneNumber(phone){
          if (!phone){
              return '';
          }
          let cleaned = ('' + phone).replace(/\D/g, '')
          let match = cleaned.match(/^(1|)?(\d{3})(\d{3})(\d{4})$/)
          if (match) {
            var intlCode = (match[1] ? '+1 ' : '')
            return [intlCode, '(', match[2], ') ', match[3], '-', match[4]].join('')
          }
          return null
    }

    function getImgFromRating(rating){
        return starRatings[Math.round(rating * 2) / 2];
    }

    function displaySickReviews(reviews, sortFunction, reviewsDiv){
        reviews.sort(sortFunction);
        var reviewHtml = document.getElementById(reviewsDiv);
        reviewHtml.innerHTML = "";
        let counter = 0;
        for(var i = 0; i < reviews.length; i++){
            var hsan = reviews[i]['classification_hsan'];
            if(!("sentence_scores" in hsan) || hsan['sentence_scores'].length != reviews[i]['sentences'].length){
                continue;
            }
            else{
                counter++;
                let reviewDiv = document.createElement('div');
                reviewDiv.className = 'review-div';
                let date = getFormattedDate(new Date(reviews[i]['date_created']));

                let reviewHeader = document.createElement('div');
                reviewHeader.className = 'review-header';

                let container = document.createElement('div');
                container.className = "inner-container";

                container.appendChild(createYelpImg(reviews[i]['review_rating'], reviews[i]['review_url']));
                container.appendChild(createTextElement(date));
                reviewHeader.appendChild(container);

                container = document.createElement('div');
                container.className = 'inner-container';
                container.appendChild(createProgressElement(reviews[i]['reg_total_score']));
                container.appendChild(createTextElement('LR'));
                container.appendChild(createProgressElement(reviews[i]['hsan_total_score']));
                container.appendChild(createTextElement('HSAN'));

                reviewHeader.appendChild(container);

                reviewDiv.appendChild(reviewHeader);

                 let sentenceIndicesToDisplay;

                 if(hsan['sick_sentences'].length > 0){
                     sentenceIndicesToDisplay = indicesOfSickSentences(hsan['sick_sentences'], reviews[i]['sentences']);
                 }
                 else{
                     sentenceIndicesToDisplay = topSickSentences(hsan['sentence_scores']);
                 }

                 for(let j = 0; j < sentenceIndicesToDisplay.length; j++){
                     let index = sentenceIndicesToDisplay[j];
                     let sentenceInfo = document.createElement('div');
                     sentenceInfo.className = 'review-info';

                     let sentenceScore = document.createElement('div');
                     sentenceScore.className = "sentence-score";
                     sentenceScore.textContent = hsan['sentence_scores'][index].toFixed(2);
                     sentenceScore.style="color: red";

                     let revText = document.createElement('div');
                     revText.className = 'review-text';
                     revText.textContent = reviews[i]['sentences'][index];

                     sentenceInfo.appendChild(sentenceScore);
                     sentenceInfo.appendChild(revText);
                     reviewDiv.appendChild(sentenceInfo);
                 }
                reviewHtml.appendChild(reviewDiv);
            }
        }
    }

    function createProgressElement(sickScore){
        let percentage = sickScore * 100;
        let fixedDecimal = sickScore.toFixed(2);

        let progressBar = document.createElement('div');
        progressBar.className= 'progress';
        let bar = document.createElement('div');
        bar.className = 'progress-bar bg-danger';
        bar.setAttribute('role', "progressbar");
        bar.setAttribute('aria-valuenow', "60");
        bar.setAttribute('aria-valuemin', "0");
        bar.setAttribute('aria-valuemax', "100");
        bar.setAttribute("style", "width: " + percentage + "%;");
        bar.textContent = fixedDecimal;

        progressBar.appendChild(bar);
        return progressBar;
    }

    function createTextElement(content) {
        let text = document.createElement('div');
        text.textContent = content;
        return text;
    }

    function createYelpImg(rating, url){
         let yelpDiv = document.createElement('div');
         let yelpLink = document.createElement('a');
         let yelpImg = document.createElement('img');
         yelpImg.src = "images/yelp-ratings-small/" + getImgFromRating(rating);
         yelpLink.href =  url;
         yelpLink.setAttribute("target", "_blank");
         yelpLink.appendChild(yelpImg);
         yelpDiv.appendChild(yelpLink);

         return yelpDiv;
    }

    function indicesOfSickSentences(sickSentences, reviewSentences){
        let indices = [];
          for(let i = 0; i< reviewSentences.length; i++){
              for(let j = 0; j < sickSentences.length; j++){
                  if (reviewSentences[i].includes(sickSentences[j]))
                      indices.push(i);
              }
          }
        return indices;
    }

    function topSickSentences(sentencesScores){
        let maxIndex = 0;
        let maxScore = sentencesScores[0];
        for(let i = 0; i< sentencesScores.length; i++){
            if (sentencesScores[i] > maxScore){
                maxScore = sentencesScores[i];
                maxIndex = i;
            }
        }
        return [maxIndex];
    }

    function compareDates(a, b){
        var aDate = a['date_created'];
        var bDate = b['date_created'];

        return aDate < bDate ? 1 : -1;
    }

    function compareLRScores(a, b){
        let compare = 'reg_total_score';

        var aScore = a[compare];
        var bScore = b[compare];

        return aScore < bScore ? 1 : -1
    }


    function compareHSANScores(a, b){
        let compare = 'hsan_total_score';

        var aScore = a[compare];
        var bScore = b[compare];

        return aScore < bScore ? 1 : -1
    }

    function changeHistogram(values){
        x = d3.scaleTime().domain([new Date(startTime), new Date(endTime)]).range([0, width]);

         var histogram = d3.histogram()
            .value(function(d) { return d; })   // I need to give the vector of value
             .domain(x.domain())  // then the domain of the graphic
            .thresholds(x.ticks(20)); // then the numbers of bins

        var bins = histogram(values);

        y.domain([0, d3.max(bins, function(d) { return d.length; })]);   // d3.hist has to be called before the Y axis obviously
        yAxis.transition()
        .duration(1000)
        .call(d3.axisLeft(y).ticks(4));

        xAxis.transition().duration(1000).call(d3.axisBottom(x).ticks(4))

        var u = svg.selectAll("rect")
                .data(bins);

    // Manage the existing bars and eventually the new ones:
        u
        .enter()
        .append("rect") // Add a new rect for each new elements
        .merge(u) // get the already existing elements as well
        .transition() // and apply changes to all of them
        .duration(1000)
          .attr("x", 1)
          .attr("transform", function(d) { return "translate(" + x(d.x0) + "," + y(d.length) + ")"; })
          .attr("width", function(d) { return Math.max(x(d.x1) - x(d.x0) -1, 0); })
          .attr("height", function(d) { return height - y(d.length); })
          .style("fill", "blue")


    // If less bar in the new histogram, I delete the ones not in use anymore
         u.exit().remove()
    }

    function styleFeature(feature) {
        var normalizedFillOpacity = (feature.getProperty('sick_score') - sickMin) /
            (sickMax-sickMin);
       // normalizedFillOpacity = 1 - normalizedFillOpacity;
        
        var outlineWeight = 0.5, zIndex = 1;
            if (feature.getProperty('state') === 'hover') {
                outlineWeight = zIndex = 2;
            }

        return {
            strokeWeight: outlineWeight,
            strokeColor: '#fff',
            fillColor: 'red',
            fillOpacity: normalizedFillOpacity,
            zIndex: zIndex
        }
    
    }

    function updateMouseoverBox(restOrZip, name, sickScore) {
          document.getElementById('mouseover-type').textContent = restOrZip;
          document.getElementById('mouseover-name').textContent = name;
          document.getElementById('sick_score').textContent = sickScore;
    }
        
    function mouseInToRegion(event) {
		event.feature.setProperty('state', 'hover');
        zipFeature['feature'] = event.feature;
        zipFeature['over'] = true;
		
		var sickScoreString = event.feature.getProperty('sick_score');
		updateMouseoverBox('Zip Code:', event.feature.getProperty('postalcode'), sickScoreString);
		if(event.feature.getProperty('review_dates')) {
            changeHistogram(event.feature.getProperty('review_dates'));
        }
	}

    function mouseOutOfRegion(event) {
        event.feature.setProperty('state', 'normal');
        zipFeature['over'] = false;
        changeHistogram(reviewsForHist);
    }
    
    </script>
    <script async defer
         src="https://maps.googleapis.com/maps/api/js?key={{ API_KEY }}&callback=initMap">
    </script>
  </body>
</html>
