<!DOCTYPE html>
<html>
  <head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src = "https://code.jquery.com/jquery-1.10.2.js"></script>
    <script src = "https://code.jquery.com/ui/1.10.4/jquery-ui.js"></script>
     <link href = "https://code.jquery.com/ui/1.10.4/themes/ui-lightness/jquery-ui.css"
              rel = "stylesheet">
	<style>
      /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
      .nicebox {
		position: absolute;
		text-align: center;
		font-family: "Roboto", "Arial", sans-serif;
		font-size: 13px;
		z-index: 5;
		box-shadow: 0 4px 6px -4px #333;
		padding: 5px 10px;
		background: rgb(255,255,255);
		background: linear-gradient(to bottom,rgba(255,255,255,1) 0%,rgba(245,245,245,1) 100%);
		border: rgb(229, 229, 229) 1px solid;
	  }
	  .ui-slider-handle {
		color: black;
		font-size: 10px;
		padding: 3px;
		text-shadow: 0 1px 0 #FFFFFF;
		text-decoration:none;
        text-align:center;
		}
      .slider-text-boxes {
          position: absolute;
          background: rgba(0,0,0,0.54);
          top: 30%;
          left: 2%;
          z-index: 900;
      }
      .ui-slider-horizontal {
          height: 8px;
          width: 200px;
          top: 50%;
          left: 5%;
          z-index: 999;
      }
      .ui-widget-content { background: purple; }
      .ui-widget-content .ui-state-default { background: red; }



  #map {
        height: 100%;
      }
      /* Optional: Makes the sample page fill the window. */
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
	  #data-box {
        top: 10px;
        left: 500px;
        height: 45px;
        line-height: 45px;
        display: none;
      }	

	  #data-value { font-size: 2.0em; font-weight: bold }
	  #data-label { font-size: 2.0em; font-weight: normal; padding-right: 10px; }
	  #data-label:after { content: ':' }
    </style>
  </head>
  <body>
   <div id="data-box" class="nicebox">
      <label id="data-label" for="data-value"></label>
      <span id="data-value"></span>
    </div>

    <div class="slider-text-boxes">
		<p>
            <label for = "sick-slider-text">Sick Review Threshold:</label>
            <input type="text" id="sick-slider-text">
            <div id = "sick-review-slider"></div>
        </p>
        <p>
            <label for = "date-slider-text">Date:</label>
            <input type="text" id="date-slider-text">
            <div id = "date-slider"></div>
        </p>
        <p>
            <label for = "rest-slider-text">Sick Restaurant Threshold</label>
            <input type="text" id="rest-slider-text">
            <div id= "sick-rest-slider"></div>
        </p>
	</div>

    <div id="map"></div>
    <script>
      var map;
      var sickMin = Number.MAX_VALUE, sickMax = -Number.MAX_VALUE;
      var sickReviewBottomThreshold = 0.5;
      var sickReviewTopThreshold = 0.8;
      var sickRestaurantThreshold = 5;
      var scalingFactor = 3;
      
      var zipFeature = {'feature': null, 'over': false};
      var markers = [];

      var startTime = (new Date(2005, 8, 2)).getTime();
      var endTime = (new Date(2020, 2, 3)).getTime();

      function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
          zoom: 11,
          center: new google.maps.LatLng(40.75,-74.00),
          mapTypeId: 'roadmap'
        });
        loadGeoJson();

        map.data.setStyle(styleFeature);
        map.data.addListener('mouseover', mouseInToRegion);
        map.data.addListener('mouseout', mouseOutOfRegion);
        
    }

    function changeMap(){
        for(var i = 0; i<markers.length; i++){
            markers[i].setMap(null);
        }
        markers = [];
        loadRestaurants();
    }

    $(function (){
        $("#sick-review-slider").slider({
            range: true,
            min: 0.1,
            max: 1.0,
            step: 0.1,
            values: [sickReviewBottomThreshold, sickReviewTopThreshold],
            slide: function(event, ui){
                 $("#sick-slider-text").val(ui.values[0] + " - " + ui.values[1]);
            },
            stop: function(event, ui){
                sickReviewBottomThreshold = ui.values[0];
                sickReviewTopThreshold = ui.values[1];
                changeMap();
            }
		})

        var sliderStartTime = new Date(2012, 1, 1).getTime() / 1000;
        var sliderStopTime =  new Date(2016, 01, 01).getTime() / 1000;

        $("#date-slider").slider({
            range: true,
            min: startTime / 1000,
            max: endTime / 1000,
            step: 604800,
            values: [sliderStartTime, sliderStopTime],
            slide: function( event, ui ) {
                 $( "#date-slider-text" ).val( getFormattedDate(new Date(ui.values[ 0 ] *1000)) + " - " + getFormattedDate(new Date(ui.values[ 1 ] *1000)));
             },
            stop: function(event, ui){
                startTime = ui.values[0] * 1000;
                endTime = ui.values[1] * 1000;
                changeMap();
            }
		})

         $("#sick-rest-slider").slider({
            min: 1,
            max: 10,
            step: 1,
            value: sickRestaurantThreshold,
            slide: function( event, ui ) {
                 $( "#rest-slider-text" ).val(ui.value);
             },
            stop: function(event, ui){
                sickRestaurantThreshold = ui.value;
                changeMap();
            }
		})

        $("#sick-slider-text").val(sickReviewBottomThreshold + " - " + sickReviewTopThreshold)
        $("#date-slider-text").val(getFormattedDate(new Date(sliderStartTime *1000)) + " - " + getFormattedDate(new Date(sliderStopTime*1000)));
        $("#rest-slider-text").val(sickRestaurantThreshold);
    })

      function getFormattedDate(date) {
          var year = date.getFullYear();

          var month = (1 + date.getMonth()).toString();
          month = month.length > 1 ? month : '0' + month;

          var day = date.getDate().toString();
          day = day.length > 1 ? day : '0' + day;

          return month + '/' + day + '/' + year;
      }

    function loadRestaurants(){
        $.getJSON("/static/test.json", function(zip_codes){
            
            sickMin = Number.MAX_VALUE;
            sickMax = -Number.MAX_VALUE;
            for(var zip in zip_codes){
                businesses = zip_codes[zip]['restaurants'];
                var zip_sick_count = 0;

                businesses.forEach(function (business){    
                   var latlng = new google.maps.LatLng(business['lat-long'][0], 
                           business['lat-long'][1]);
                   
                   var aboveThreshold = 0;
                   for(var i = 0; i<business['reviews'].length; i++){
                       var reviewScore = business['reviews'][i]['classification'];
                       var reviewTime = Date.parse(business['reviews'][i]['review_date']);

                       if (reviewScore < sickReviewBottomThreshold ||
                           reviewScore > sickReviewTopThreshold ||
                           reviewTime < startTime ||
                           reviewTime > endTime){

                           continue;
                       }
                       else{
                           aboveThreshold += 1;
                       }
                   }

                   zip_sick_count += aboveThreshold;
                   if(aboveThreshold < sickRestaurantThreshold){
                     return;
                   }

                   var marker = new google.maps.Marker({
                       map: map,
                       icon: {
                           path: google.maps.SymbolPath.CIRCLE,
                           scale: aboveThreshold/scalingFactor,
                           fillColor: 'blue',
                           fillOpacity: 0.3,
                           strokeWeight: 1,
                           strokeColor:'grey'
                       },
                       position: latlng,
                       title: business['business_name'],
                       sick_score: aboveThreshold,
                       zIndex: 999
                   })

                   google.maps.event.addListener(marker, 'mouseover', function() {
                        update_mouseover_box(this.title, this.sick_score);

                        var icon = this.icon;
                        icon.scale = icon.scale + 3;
                        this.setIcon(icon);
                    });

                   google.maps.event.addListener(marker, 'mouseout', function() {
                       if(zipFeature['over']){
                           var feature = zipFeature['feature'];
                           var sickScoreString = feature.getProperty('sick_score');
                           update_mouseover_box(feature.getProperty('postalcode'), sickScoreString);

                           var icon = this.icon;
                           icon.scale = icon.scale - 3;
                           this.setIcon(icon);
                       }
                   });  
                   markers.push(marker);
                })

                if(zip_sick_count > sickMax){
                    sickMax = zip_sick_count;
                }
                if(zip_sick_count < sickMin){
                    sickMin = zip_sick_count;
                }
                var feature = map.data.getFeatureById(zip);
                if(feature === undefined){
                   // console.log("undefined");
                }
                else{
                    feature.setProperty('sick_score', zip_sick_count);
                }
            }

    	})
	}

    function loadGeoJson() {
        map.data.loadGeoJson('/static/nyc_zip_code.geojson', {idPropertyName :'postalcode'});
        google.maps.event.addListenerOnce(map.data, 'addfeature', function() {
    //        loadSickData();
            loadRestaurants();
        });
    }


    function styleFeature(feature) {
        var normalizedFillOpacity = (feature.getProperty('sick_score') - sickMin) /
            (sickMax-sickMin);
       // normalizedFillOpacity = 1 - normalizedFillOpacity;
        
        var outlineWeight = 0.5, zIndex = 1;
            if (feature.getProperty('state') === 'hover') {
                outlineWeight = zIndex = 2;
            }

        return {
            strokeWeight: outlineWeight,
            strokeColor: '#fff',
            fillColor: 'red',
            fillOpacity: normalizedFillOpacity,
            zIndex: zIndex
        }
    
    }

    function update_mouseover_box(dataLabel, dataValue) {
          document.getElementById('data-label').textContent = dataLabel;
          document.getElementById('data-value').textContent = dataValue;
          document.getElementById('data-box').style.display = 'block';
    }
        
    function mouseInToRegion(event) {
		event.feature.setProperty('state', 'hover');
        zipFeature['feature'] = event.feature;
        zipFeature['over'] = true;
		
		var sickScoreString = event.feature.getProperty('sick_score');
		update_mouseover_box(event.feature.getProperty('postalcode'), sickScoreString);
	}

    function mouseOutOfRegion(event) {
        event.feature.setProperty('state', 'normal');
        zipFeature['over'] = false;
    }
    
    </script>
    <script async defer
         src="https://maps.googleapis.com/maps/api/js?key={{ API_KEY }}&callback=initMap">
    </script>
  </body>
</html>

