<!DOCTYPE html>
<html>
  <head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src = "https://code.jquery.com/jquery-1.10.2.js"></script>
    <script src = "https://code.jquery.com/ui/1.10.4/jquery-ui.js"></script>
     <link href = "https://code.jquery.com/ui/1.10.4/themes/ui-lightness/jquery-ui.css"
              rel = "stylesheet">
	<style>
      /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
      .nicebox {
		position: absolute;
		text-align: center;
		font-family: "Roboto", "Arial", sans-serif;
		font-size: 13px;
		z-index: 5;
		box-shadow: 0 4px 6px -4px #333;
		padding: 5px 10px;
		background: rgb(255,255,255);
		background: linear-gradient(to bottom,rgba(255,255,255,1) 0%,rgba(245,245,245,1) 100%);
		border: rgb(229, 229, 229) 1px solid;
	  }
	  .ui-slider-handle {
		color: black;
		font-size: 10px;
	/*	padding: 3px;*/
		text-shadow: 0 1px 0 #FFFFFF;
		text-decoration:none;
        text-align:center;
		}
      
      .ui-slider-horizontal {
          height: 8px;
          width: 200px;
          top: 50%;
          left: 5%;
          z-index: 999;
      }
      .ui-widget-content { background: purple; }
      .ui-widget-content .ui-state-default { background: red; }
  #map {
        height: 100%;
      }
      /* Optional: Makes the sample page fill the window. */
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
	  #data-box {
        top: 10px;
        left: 500px;
        height: 45px;
        line-height: 45px;
        display: none;
      }	

	  #data-value { font-size: 2.0em; font-weight: bold }
	  #data-label { font-size: 2.0em; font-weight: normal; padding-right: 10px; }
	  #data-label:after { content: ':' }
    </style>
  </head>
  <body>
   <div id="data-box" class="nicebox">
      <label id="data-label" for="data-value"></label>
      <span id="data-value"></span>
    </div>
   
    <div id = "slider"></div>
    <label for = "slidevalue">Slide:</label>
    <input type = "text" id = "slidevalue" 
    style = "border:0; color:#b9cd6d; font-weight:bold;">
    
    <div id="map"></div>
    <script>
      var map;
      var sickMin = Number.MAX_VALUE, sickMax = -Number.MAX_VALUE;
      var sickReviewThreshold = 0.5;
      var sickRestaurantThreshold = 5;
      var scalingFactor = 3;
        
      var markers = [];

      function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
          zoom: 11,
          center: new google.maps.LatLng(40.75,-74.00),
          mapTypeId: 'roadmap'
        });
        loadGeoJson();

        map.data.setStyle(styleFeature);
        map.data.addListener('mouseover', mouseInToRegion);
        map.data.addListener('mouseout', mouseOutOfRegion);
        
    }

    function changeMap(){
        for(var i = 0; i<markers.length; i++){
            markers[i].setMap(null);
        }
        markers = [];
        loadRestaurants();
    }

    $(function (){
        $("#slider").slider({
            min: 0.1,
            max: 0.9,
            step: 0.1,
            value: sickReviewThreshold,
            slide: function(event, ui){
                 $(this).find(".ui-slider-handle").text(ui.value);
            },
            create: function(event, ui){
                 $(this).find(".ui-slider-handle").text($( this ).slider( "value" ));
            },
            stop: function(event, ui){
                sickReviewThreshold = ui.value;
                changeMap();
            }
		})
    })

/*    function loadSickData(){
        $.getJSON("/static/zip_sick.json", function(data){
            var sick_scores = data['sick'];
            for(var postalcode in sick_scores){
                var sickScore = sick_scores[postalcode];
                
                if(sickScore > sickMax){
                    sickMax = sickScore;
                }
                if(sickScore < sickMin){
                    sickMin = sickScore;
                }
                var feature = map.data.getFeatureById(postalcode);
                if(feature === undefined){
                   // console.log("undefined");
                }
                else{
                    feature.setProperty('sick_score', sickScore);
                }
            }
        })
    }
  */  
    function loadRestaurants(){
        $.getJSON("/static/test.json", function(zip_codes){
            
            sickMin = Number.MAX_VALUE;
            sickMax = -Number.MAX_VALUE;
            for(var zip in zip_codes){
                businesses = zip_codes[zip]['restaurants'];
                var zip_sick_count = 0;

                businesses.forEach(function (business){    
                   var latlng = new google.maps.LatLng(business['lat-long'][0], 
                           business['lat-long'][1]);
                   
                   var aboveThreshold = 0;
                   for(var i = 0; i<business['reviews'].length; i++){
                       if (business['reviews'][i]['classification'] < sickReviewThreshold){
                           continue;
                       }
                       else{
                           aboveThreshold += 1;
                       }
                   }

                   zip_sick_count += aboveThreshold;
                   if(aboveThreshold < sickRestaurantThreshold){
                     return;
                   }

                   var marker = new google.maps.Marker({
                       map: map,
                       icon: {
                           path: google.maps.SymbolPath.CIRCLE,
                           scale: aboveThreshold/scalingFactor,
                           fillColor: 'blue',
                           fillOpacity: 0.3,
                           strokeWeight: 1,
                           strokeColor:'grey'
                       },
                       position: latlng,
                       title: business['business_name'],
                       sick_score: aboveThreshold,
                       zIndex: 999
                   })

                   google.maps.event.addListener(marker, 'mouseover', function() {
                        document.getElementById('data-label').textContent = this.title;
                        document.getElementById('data-value').textContent = this.sick_score;
                    });

                   google.maps.event.addListener(marker, 'mouseout', function() {
                   });  
                   markers.push(marker);
                })

                if(zip_sick_count > sickMax){
                    sickMax = zip_sick_count;
                }
                if(zip_sick_count < sickMin){
                    sickMin = zip_sick_count;
                }
                var feature = map.data.getFeatureById(zip);
                if(feature === undefined){
                   // console.log("undefined");
                }
                else{
                    feature.setProperty('sick_score', zip_sick_count);
                }
            }

    	})
	}

    function loadGeoJson() {
        map.data.loadGeoJson('/static/nyc_zip_code.geojson', {idPropertyName :'postalcode'});
        google.maps.event.addListenerOnce(map.data, 'addfeature', function() {
    //        loadSickData();
            loadRestaurants();
        });
    }


    function styleFeature(feature) {
        var normalizedFillOpacity = (feature.getProperty('sick_score') - sickMin) /
            (sickMax-sickMin);
        console.log(sickMax);
       // normalizedFillOpacity = 1 - normalizedFillOpacity;
        
        return {
            strokeWeight: 2,
            strokeColor: '#fff',
            fillColor: 'red',
            fillOpacity: normalizedFillOpacity
        }
    
    }
        
    function mouseInToRegion(event) {
        map.data.revertStyle();
        map.data.overrideStyle(event.feature, {strokeWeight: 8});
		document.getElementById('data-label').textContent =
            event.feature.getProperty('postalcode');
		
		var sickScoreString = event.feature.getProperty('sick_score');
		
		document.getElementById('data-value').textContent = sickScoreString;
		document.getElementById('data-box').style.display = 'block';

	}

    function mouseOutOfRegion(event) {
        map.data.revertStyle();
    }
    
    </script>
    <script async defer
         src="https://maps.googleapis.com/maps/api/js?key={{ API_KEY }}&callback=initMap">
    </script>
  </body>
</html>

