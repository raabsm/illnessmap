<!DOCTYPE html>
<html>
  <head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src = "https://code.jquery.com/jquery-1.10.2.js"></script>
    <script src = "https://code.jquery.com/ui/1.10.4/jquery-ui.js"></script>
     <link href = "https://code.jquery.com/ui/1.10.4/themes/ui-lightness/jquery-ui.css"
              rel = "stylesheet">
	<style>
      /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
      .nicebox {
		position: absolute;
		text-align: center;
		font-family: "Roboto", "Arial", sans-serif;
		font-size: 13px;
		z-index: 5;
		box-shadow: 0 4px 6px -4px #333;
		padding: 5px 10px;
		background: rgb(255,255,255);
		background: linear-gradient(to bottom,rgba(255,255,255,1) 0%,rgba(245,245,245,1) 100%);
		border: rgb(229, 229, 229) 1px solid;
	  }
	  .ui-slider-handle {
		color: black;
		font-size: 10px;
		padding: 3px;
		text-shadow: 0 1px 0 #FFFFFF;
		text-decoration:none;
        text-align:center;
		}
      .text-box {
          position: absolute;
          padding: 10px;
          background: rgba(0, 0, 0, 0.91);
          z-index: 900;
          color: #eaf2ff;
      }
      .ui-slider-horizontal {
          height: 8px;
          width: 200px;
          z-index: 999;
      }
      .ui-widget-content {
          background: white;
          margin-bottom: 10px;
      }
      .ui-slider-horizontal .ui-slider-range {
            top: 0;
            background: navajowhite;
            height: 100%;
        }
      .ui-widget-content .ui-state-default {
          background: red;
          width: 3px;
          height: 10px;
      }



  #map {
        height: 100%;
      }
      /* Optional: Makes the sample page fill the window. */
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
	  #data-box {
        top: 10px;
        left: 500px;
        height: 45px;
        line-height: 45px;
        display: none;
      }	

	  #data-value { font-size: 2.0em; font-weight: bold }
	  #data-label { font-size: 2.0em; font-weight: normal; padding-right: 10px; }
	  #data-label:after { content: ':' }

        #slider-box{
            top: 50px;
            left: 10px;

        }
        #rest-info-box{
            top: 50px;
            width: 500px;
            right: 10px;
            padding: 10px;
            text-align: center;
            display: none;
        }
        #rest-title{
            font-weight: 400;
            margin-bottom: 10px;
            text-align: center;
            font-size: 25px;
            color: navajowhite;
        }
        .rest-info{
            line-height: 28px;
            text-align: left;
        }

        .rest-info-title{
            display: inline-block;
            color: white;
        }
        .rest-info-value{
            float: right;
            display: inline-block;
            color: #eee;
        }
        .slider-title{
            line-height: 28px;
            text-align: left;
            color: navajowhite;
            font-size: 20px;
            display: inline-flex;
        }
        .review-text{
            text-align: left;
            max-height: 150px;
            overflow: auto;
        }

    </style>
  </head>
  <body>
   <div id="data-box" class="nicebox">
      <label id="data-label" for="data-value"></label>
      <span id="data-value"></span>
    </div>

    <div id=slider-box class="text-box">

            <div class="slider-title">Sick Review Slider</div>
            <div id="sick-slider-text" class="rest-info"></div>
            <div id = "sick-review-slider"></div>


            <div class="slider-title">Date Slider</div>
            <form id="select-form" style = "display: inline; float: right; margin-top: 4px">
              <select id="date-select">
                  <option selected="selected" value = "custom">Custom</option>
                  <option value = "week">Last Week</option>
                  <option value = "month">Last Month</option>
                  <option value = "6month">Last 6 Months</option>
                  <option value = "year">Last Year</option>
              </select>
            </form>
            <div id="date-slider-text" class="rest-info"></div>
            <div id = "date-slider"></div>


           <div class="slider-title">Restaurant Threshold Slider</div>
            <div id="rest-slider-text" class="rest-info"></div>
            <div id = "sick-rest-slider"></div>


        <button onclick="scaleUp()">Scale Up</button>
        <button onclick="deselectMarker()">Deselect</button>

	</div>

   <div id="rest-info-box" class="text-box">
       <a href="#" target = "_blank" id="rest-title" style="text-align: center;"></a>
       <div class="rest-info">
           <div class="rest-info-title">Address: </div>
           <div class="rest-info-value" id="address"></div>
       </div>
       <div class="rest-info">
           <div class="rest-info-title">Rating: </div>
           <div class="rest-info-value" id="rating"></div>
       </div>
        <div class="rest-info">
           <div class="rest-info-title">Sick Score: </div>
           <div class="rest-info-value" id="sick_score"></div>
       </div>
       <div class="rest-info">
           <div class="rest-info-title">Total Reviews: </div>
           <div class="rest-info-value" id="total-reviews"></div>
       </div>
       <a href="#" target = "_blank" id="max-review-title" class="rest-info" style="color:navajowhite"></a>
       <div id="max-review" class="review-text"></div>
       <a href="#" target = "_blank" id="recent-review-title" class="rest-info" style="color:navajowhite"></a>
       <div id="recent-review" class="review-text"></div>
   </div>

    <div id="map"></div>
    <script>
      var map;
      var sickMin = Number.MAX_VALUE, sickMax = -Number.MAX_VALUE;
      var sickReviewBottomThreshold = 0.5;
      var sickReviewTopThreshold = 0.8;
      var sickRestaurantThreshold = 5;
      var scalingFactor = 3;
      var selectedMarker = null;
      var selectedMarkerIcon = null;
      
      var zipFeature = {'feature': null, 'over': false};
      var markers = [];

      var startTime = (new Date(2005, 8, 2)).getTime();
      var endTime = (new Date()).getTime();

      function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
          zoom: 11,
          center: new google.maps.LatLng(40.75,-74.00),
          mapTypeId: 'roadmap'
        });
        loadGeoJson();
        // google.maps.event.addDomListener(document.getElementById('map'), 'dblclick', function() {
        //     document.getElementById('rest-info-box').style.display = 'none';
        //     if(selectedMarker != null){
        //         makeNeutralIcon(selectedMarker, 5);
        //         selectedMarker = null;
        //     }
        // });

        map.data.setStyle(styleFeature);
        map.data.addListener('mouseover', mouseInToRegion);
        map.data.addListener('mouseout', mouseOutOfRegion);
        
    }

    function deselectMarker(){
          document.getElementById('rest-info-box').style.display = 'none';
            if(selectedMarker != null){
                makeNeutralIcon(selectedMarker);
                selectedMarker = null;
            }
    }

    function changeMap(){
        for(var i = 0; i<markers.length; i++){
            markers[i].setMap(null);
        }
        markers = [];
        loadRestaurants();
    }

    $(function (){
        $("#sick-review-slider").slider({
            range: true,
            min: 0.1,
            max: 1.0,
            step: 0.1,
            values: [sickReviewBottomThreshold, sickReviewTopThreshold],
            slide: function(event, ui){
                 $("#sick-slider-text").text( ui.values[0] + " - " + ui.values[1]);
            },
            stop: function(event, ui){
                sickReviewBottomThreshold = ui.values[0];
                sickReviewTopThreshold = ui.values[1];
                changeMap();
            }
		})

        var sliderStartTime = new Date(2012, 1, 1).getTime() / 1000;
        var sliderStopTime =  new Date(2016, 01, 01).getTime() / 1000;

        $("#date-slider").slider({
            range: true,
            min: startTime / 1000,
            max: endTime / 1000,
            step: 604800,
            values: [sliderStartTime, sliderStopTime],
            slide: function( event, ui ) {
                 $( "#date-slider-text" ).text( getFormattedDate(new Date(ui.values[ 0 ] *1000)) + " - " + getFormattedDate(new Date(ui.values[ 1 ] *1000)));
             },
            change: function(event, ui){
                $( "#date-slider-text" ).text( getFormattedDate(new Date(ui.values[ 0 ] *1000)) + " - " + getFormattedDate(new Date(ui.values[ 1 ] *1000)));
                startTime = ui.values[0] * 1000;
                endTime = ui.values[1] * 1000;
                changeMap();
            }
		})

         $("#sick-rest-slider").slider({
            min: 1,
            max: 10,
            step: 1,
            value: sickRestaurantThreshold,
            slide: function( event, ui ) {
                 $( "#rest-slider-text" ).text(ui.value);
             },
            stop: function(event, ui){
                sickRestaurantThreshold = ui.value;
                changeMap();
            }
		})

        $("#sick-slider-text").text(sickReviewBottomThreshold + " - " + sickReviewTopThreshold);
        $("#date-slider-text").text(getFormattedDate(new Date(sliderStartTime *1000)) + " - " + getFormattedDate(new Date(sliderStopTime*1000)));
        $("#rest-slider-text").text(sickRestaurantThreshold);

        $("#date-select").on("change", function() {
            var today = new Date();
            var option = this.value;
            var date = new Date();
            $("#date-slider").slider("disable");

            if (option == 'week'){
                date.setDate(today.getDate() - 7);
            }
            else if(option == 'month'){
                date.setMonth(today.getMonth() - 1);
            }
            else if(option == '6month'){
                date.setMonth(today.getMonth() - 6);
            }
            else if(option == 'year'){
                date.setFullYear(today.getFullYear() - 1);
            }
            else{
                $("#date-slider").slider("enable");
                date = new Date(startTime);
            }

            $("#date-slider").slider("values", [date.getTime()/1000, today.getTime()/1000]);
        })
    })

      function getFormattedDate(date) {
          var year = date.getFullYear();

          var month = (1 + date.getMonth()).toString();
          month = month.length > 1 ? month : '0' + month;

          var day = date.getDate().toString();
          day = day.length > 1 ? day : '0' + day;

          return month + '/' + day + '/' + year;
      }

    function loadRestaurants(){
        $.getJSON("/static/march_zipcode_sick_reviews.json", function(zip_codes){
            console.log('hello');
            sickMin = Number.MAX_VALUE;
            sickMax = -Number.MAX_VALUE;
            for(var zip in zip_codes){
                businesses = zip_codes[zip];
                var zip_sick_count = 0;

                businesses.forEach(function (business){    
                   var latlng = new google.maps.LatLng(business['lat-long'][0], 
                           business['lat-long'][1]);

                   var max_review = null;
                   var most_recent_review = null;
                   var max_review_value = 0;
                   var most_recent_review_value = new Date(-8640000000000000);

                   var aboveThreshold = 0;
                   for(var i = 0; i<business['reviews'].length; i++){
                       var reviewScore = business['reviews'][i]['reg_total_score'];
                       var reviewTime = Date.parse(business['reviews'][i]['date_created']);

                       if (reviewScore < sickReviewBottomThreshold ||
                           reviewScore > sickReviewTopThreshold ||
                           reviewTime < startTime ||
                           reviewTime > endTime){

                           continue;
                       }
                       else{
                           if(reviewScore > max_review_value){
                               max_review = business['reviews'][i];
                               max_review_value = reviewScore;
                           }
                           if(reviewTime > most_recent_review_value){
                               most_recent_review = business['reviews'][i];
                               most_recent_review_value = reviewTime;
                           }
                           aboveThreshold += 1;
                       }
                   }

                   zip_sick_count += aboveThreshold;
                   if(aboveThreshold < sickRestaurantThreshold){
                     return;
                   }

                   var marker = new google.maps.Marker({
                       map: map,
                       icon: {
                           path: google.maps.SymbolPath.CIRCLE,
                           scale: aboveThreshold/scalingFactor,
                           fillColor: 'blue',
                           fillOpacity: 0.3,
                           strokeWeight: 1,
                           strokeColor:'grey'
                       },
                       position: latlng,
                       sick_score: aboveThreshold,
                       rest_info:{
                           name: business['name'],
                           address: business['address'],
                           total_review_count: business['review_count'],
                           url: business['url'],
                           rating: business['rating'],
                           max_review: max_review,
                           most_recent_review: most_recent_review
                       },
                       zIndex: 999
                   })

                   google.maps.event.addListener(marker, 'mouseover', function() {
                        updateMouseoverBox(this.rest_info.name, this.sick_score);

                        var icon = this.icon;
                        icon.scale = icon.scale + 3;
                        this.setIcon(icon);
                    });

                    google.maps.event.addListener(marker, 'click', function() {
                        updateClickBox(this.sick_score, this.rest_info);
                        if(selectedMarker != null){
                            makeNeutralIcon(selectedMarker);
                        }
                        selectedMarkerIcon = this.icon;
                        selectedMarker = this;

                        this.setIcon('https://www.google.com/mapfiles/marker_green.png');

                    });

                   google.maps.event.addListener(marker, 'mouseout', function() {
                       if(zipFeature['over']){
                           var feature = zipFeature['feature'];
                           var sickScoreString = feature.getProperty('sick_score');
                           updateMouseoverBox(feature.getProperty('postalcode'), sickScoreString);

                            var icon = this.icon;
                            icon.scale = icon.scale - 3;
                            this.setIcon(icon);
                       }
                   });  
                   markers.push(marker);
                })

                if(zip_sick_count > sickMax){
                    sickMax = zip_sick_count;
                }
                if(zip_sick_count < sickMin){
                    sickMin = zip_sick_count;
                }
                var feature = map.data.getFeatureById(zip);
                if(feature === undefined){
                   // console.log("undefined");
                }
                else{
                    feature.setProperty('sick_score', zip_sick_count);
                }
            }

    	}).fail(function (jqxhr, status, error) {
console.log('error', status, error) }
);
	}

	function makeNeutralIcon(marker){
        selectedMarkerIcon.scale -= 3;
        marker.setIcon(selectedMarkerIcon);
    }
    function loadGeoJson() {
        map.data.loadGeoJson('/static/nyc_zip_code.geojson', {idPropertyName :'postalcode'});
        google.maps.event.addListenerOnce(map.data, 'addfeature', function() {
    //        loadSickData();
            loadRestaurants();
        });
    }

    function scaleUp(){
          for(var i =0; i < markers.length; i++){
              var icon = markers[i].icon;
              icon.scale += 1;
              markers[i].setIcon(icon);
          }
    }

    function updateClickBox(sickScore, restInfo){
          var box = document.getElementById('rest-info-box');
          box.style.display = 'block';
          document.getElementById('rest-title').href = restInfo.url;
          document.getElementById('rest-title').textContent = restInfo.name;
          document.getElementById('address').textContent = restInfo.address;
          document.getElementById('rating').textContent = restInfo.rating;
          document.getElementById('total-reviews').textContent = restInfo.total_review_count;
          document.getElementById('sick_score').textContent = sickScore;
          document.getElementById('max-review-title').href = restInfo.max_review.review_url;
          document.getElementById('max-review-title').textContent = 'Max Review';
          document.getElementById('max-review').textContent = restInfo.max_review.text;
          document.getElementById('recent-review-title').href = restInfo.most_recent_review.review_url;
          document.getElementById('recent-review-title').textContent = 'Recent Review';
          document.getElementById('recent-review').textContent = restInfo.most_recent_review.text;
    }


    function styleFeature(feature) {
        var normalizedFillOpacity = (feature.getProperty('sick_score') - sickMin) /
            (sickMax-sickMin);
       // normalizedFillOpacity = 1 - normalizedFillOpacity;
        
        var outlineWeight = 0.5, zIndex = 1;
            if (feature.getProperty('state') === 'hover') {
                outlineWeight = zIndex = 2;
            }

        return {
            strokeWeight: outlineWeight,
            strokeColor: '#fff',
            fillColor: 'red',
            fillOpacity: normalizedFillOpacity,
            zIndex: zIndex
        }
    
    }

    function updateMouseoverBox(dataLabel, dataValue) {
          document.getElementById('data-label').textContent = dataLabel;
          document.getElementById('data-value').textContent = dataValue;
          document.getElementById('data-box').style.display = 'block';
    }
        
    function mouseInToRegion(event) {
		event.feature.setProperty('state', 'hover');
        zipFeature['feature'] = event.feature;
        zipFeature['over'] = true;
		
		var sickScoreString = event.feature.getProperty('sick_score');
		updateMouseoverBox(event.feature.getProperty('postalcode'), sickScoreString);
	}

    function mouseOutOfRegion(event) {
        event.feature.setProperty('state', 'normal');
        zipFeature['over'] = false;
    }
    
    </script>
    <script async defer
         src="https://maps.googleapis.com/maps/api/js?key={{ API_KEY }}&callback=initMap">
    </script>
  </body>
</html>

